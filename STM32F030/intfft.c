/*------------------------------------------------------------------------/
/  Integer DFT module
/-------------------------------------------------------------------------/
/
/  Copyright (C) 2010, ChaN, all right reserved.
/
/ * This software is a free software and there is NO WARRANTY.
/ * No restriction on use. You can use, modify and redistribute it for
/   personal, non-profit or commercial products UNDER YOUR RESPONSIBILITY.
/ * Redistributions of source code must retain the above copyright notice.
/
/-------------------------------------------------------------------------*/


#include "intfft.h"

const uint16_t Tbl_brev[] = {
#if   N_FFT == 64
	0,32,16,48,8,40,24,56,4,36,20,52,12,44,28,60,2,34,18,50,10,42,26,58,6,38,22,54,14,46,30,62
#elif N_FFT == 128
	0,64,32,96,16,80,48,112,8,72,40,104,24,88,56,120,4,68,36,100,20,84,52,116,12,76,44,108,28,92,60,124,2,66,34,98,18,82,50,114,10,74,42,106,26,90,58,122,6,70,38,102,22,86,54,118,14,78,46,110,30,94,62,126
#elif N_FFT == 256
	0,128,64,192,32,160,96,224,16,144,80,208,48,176,112,240,8,136,72,200,40,168,104,232,24,152,88,216,56,184,120,248,4,132,68,196,36,164,100,228,20,148,84,212,52,180,116,244,12,140,76,204,44,172,108,236,28,156,92,220,60,188,124,252,2,130,66,194,34,162,98,226,18,146,82,210,50,178,114,242,10,138,74,202,42,170,106,234,26,154,90,218,58,186,122,250,6,134,70,198,38,166,102,230,22,150,86,214,54,182,118,246,14,142,78,206,46,174,110,238,30,158,94,222,62,190,126,254
#elif N_FFT == 512
	0,256,128,384,64,320,192,448,32,288,160,416,96,352,224,480,16,272,144,400,80,336,208,464,48,304,176,432,112,368,240,496,8,264,136,392,72,328,200,456,40,296,168,424,104,360,232,488,24,280,152,408,88,344,216,472,56,312,184,440,120,376,248,504,4,260,132,388,68,324,196,452,36,292,164,420,100,356,228,484,20,276,148,404,84,340,212,468,52,308,180,436,116,372,244,500,12,268,140,396,76,332,204,460,44,300,172,428,108,364,236,492,28,284,156,412,92,348,220,476,60,316,188,444,124,380,252,508,2,258,130,386,66,322,194,450,34,290,162,418,98,354,226,482,18,274,146,402,82,338,210,466,50,306,178,434,114,370,242,498,10,266,138,394,74,330,202,458,42,298,170,426,106,362,234,490,26,282,154,410,90,346,218,474,58,314,186,442,122,378,250,506,6,262,134,390,70,326,198,454,38,294,166,422,102,358,230,486,22,278,150,406,86,342,214,470,54,310,182,438,118,374,246,502,14,270,142,398,78,334,206,462,46,302,174,430,110,366,238,494,30,286,158,414,94,350,222,478,62,318,190,446,126,382,254,510
#elif N_FFT == 1024

#endif
};

uint16_t isqrt32 (uint32_t l)
{
	uint32_t h, b, n;


	b = 1; h = 0; n = 16;
	do {
		h = h << 2 | l >> 30;
		l <<= 2;
		if (h & 0x80000000) h += b; else h -= b;
		b = (b << 1 & ~7) | 5;
		if (h & 0x80000000) b -= 2;
	} while (--n);
	return (uint16_t)(b >> 2);
}

uint32_t isqrt64 (uint64_t l)
{
	uint64_t h, b;
	uint32_t n;


	b = 1; h = 0; n = 32;
	do {
		h = h << 2 | l >> 62;
		l <<= 2;
		if (h & 0x8000000000000000) h += b; else h -= b;
		b = (b << 1 & ~7) | 5;
		if (h & 0x8000000000000000) b -= 2;
	} while (--n);
	return (uint32_t)(b >> 2);
}

void int16fft_exec (
	int16comp_t* fftbuf	/* Pointer to the FFT working buffer (waveform data with normal order) */
)
{
	static const int16_t sintbl[] = {
#if   N_FFT == 64
		0,3211,6392,9512,12539,15446,18204,20787,23170,25329,27245,28898,30273,31357,32138,32610,32767,32610,32138,31357,30273,28898,27245,25330,23170,20787,18204,15446,12539,9512,6392,3211,0,-3211,-6392,-9511,-12539,-15446,-18204,-20787,-23170,-25329,-27245,-28898,-30273,-31356,-32138,-32610
#elif N_FFT == 128
		0,1607,3211,4808,6392,7961,9512,11039,12539,14010,15446,16846,18204,19519,20787,22005,23170,24279,25329,26319,27245,28106,28898,29621,30273,30852,31357,31785,32138,32413,32610,32728,32767,32728,32610,32413,32138,31785,31357,30852,30273,29621,28898,28106,27245,26319,25330,24279,23170,22005,20787,19519,18204,16846,15446,14010,12539,11039,9512,7962,6392,4808,3211,1607,0,-1607,-3211,-4807,-6392,-7961,-9511,-11039,-12539,-14010,-15446,-16846,-18204,-19519,-20787,-22005,-23170,-24279,-25329,-26319,-27245,-28105,-28898,-29621,-30273,-30852,-31356,-31785,-32138,-32413,-32610,-32728
#elif N_FFT == 256
		0,804,1607,2410,3211,4011,4808,5602,6392,7179,7961,8739,9512,10278,11039,11793,12539,13278,14010,14732,15446,16151,16846,17530,18204,18868,19519,20159,20787,21403,22005,22594,23170,23732,24279,24812,25329,25832,26319,26790,27245,27684,28106,28510,28898,29269,29621,29956,30273,30572,30852,31114,31357,31581,31785,31971,32138,32285,32413,32521,32610,32679,32728,32758,32767,32758,32728,32679,32610,32521,32413,32285,32138,31971,31785,31581,31357,31114,30852,30572,30273,29956,29621,29269,28898,28511,28106,27684,27245,26790,26319,25832,25330,24812,24279,23732,23170,22594,22005,21403,20787,20159,19519,18868,18204,17530,16846,16151,15446,14732,14010,13279,12539,11793,11039,10278,9512,8739,7962,7179,6392,5602,4808,4011,3211,2410,1607,804,0,-804,-1607,-2410,-3211,-4011,-4807,-5601,-6392,-7179,-7961,-8739,-9511,-10278,-11039,-11792,-12539,-13278,-14010,-14732,-15446,-16151,-16846,-17530,-18204,-18867,-19519,-20159,-20787,-21403,-22005,-22594,-23170,-23732,-24279,-24812,-25329,-25832,-26319,-26790,-27245,-27684,-28105,-28510,-28898,-29269,-29621,-29956,-30273,-30572,-30852,-31114,-31356,-31580,-31785,-31971,-32138,-32285,-32413,-32521,-32610,-32679,-32728,-32758
#elif N_FFT == 512
		0,402,804,1206,1607,2009,2410,2811,3211,3611,4011,4409,4808,5205,5602,5997,6392,6786,7179,7571,7961,8351,8739,9126,9512,9896,10278,10659,11039,11416,11793,12167,12539,12910,13278,13645,14010,14372,14732,15090,15446,15800,16151,16499,16846,17189,17530,17869,18204,18537,18868,19195,19519,19841,20159,20475,20787,21097,21403,21706,22005,22301,22594,22884,23170,23453,23732,24007,24279,24547,24812,25072,25329,25583,25832,26077,26319,26557,26790,27020,27245,27466,27684,27897,28106,28310,28510,28707,28898,29086,29269,29447,29621,29791,29956,30117,30273,30425,30572,30714,30852,30985,31114,31237,31357,31471,31581,31685,31785,31881,31971,32057,32138,32214,32285,32351,32413,32469,32521,32568,32610,32647,32679,32706,32728,32745,32758,32765,32767,32765,32758,32745,32728,32706,32679,32647,32610,32568,32521,32469,32413,32351,32285,32214,32138,32057,31971,31881,31785,31685,31581,31471,31357,31237,31114,30985,30852,30714,30572,30425,30273,30117,29956,29791,29621,29447,29269,29086,28898,28707,28511,28310,28106,27897,27684,27466,27245,27020,26790,26557,26319,26078,25832,25583,25330,25073,24812,24547,24279,24007,23732,23453,23170,22884,22594,22301,22005,21706,21403,21097,20787,20475,20159,19841,19519,19195,18868,18537,18204,17869,17530,17189,16846,16500,16151,15800,15446,15090,14732,14372,14010,13645,13279,12910,12539,12167,11793,11417,11039,10659,10278,9896,9512,9126,8739,8351,7962,7571,7179,6786,6392,5997,5602,5205,4808,4410,4011,3611,3211,2811,2410,2009,1607,1206,804,402,0,-402,-804,-1206,-1607,-2009,-2410,-2811,-3211,-3611,-4011,-4409,-4807,-5205,-5601,-5997,-6392,-6786,-7179,-7571,-7961,-8351,-8739,-9126,-9511,-9896,-10278,-10659,-11039,-11416,-11792,-12167,-12539,-12910,-13278,-13645,-14010,-14372,-14732,-15090,-15446,-15800,-16151,-16499,-16846,-17189,-17530,-17869,-18204,-18537,-18867,-19195,-19519,-19841,-20159,-20475,-20787,-21096,-21403,-21705,-22005,-22301,-22594,-22884,-23170,-23452,-23732,-24007,-24279,-24547,-24812,-25072,-25329,-25583,-25832,-26077,-26319,-26556,-26790,-27020,-27245,-27466,-27684,-27897,-28105,-28310,-28510,-28707,-28898,-29086,-29269,-29447,-29621,-29791,-29956,-30117,-30273,-30425,-30572,-30714,-30852,-30985,-31114,-31237,-31356,-31471,-31580,-31685,-31785,-31881,-31971,-32057,-32138,-32214,-32285,-32351,-32413,-32469,-32521,-32568,-32610,-32647,-32679,-32706,-32728,-32745,-32758,-32765
#elif N_FFT == 1024
		0,201,402,603,804,1005,1206,1406,1607,1808,2009,2210,2410,2611,2811,3011,3211,3411,3611,3811,4011,4210,4409,4609,4808,5006,5205,5403,5602,5800,5997,6195,6392,6589,6786,6983,7179,7375,7571,7766,7961,8156,8351,8545,8739,8933,9126,9319,9512,9704,9896,10087,10278,10469,10659,10849,11039,11228,11416,11605,11793,11980,12167,12353,12539,12725,12910,13094,13278,13462,13645,13828,14010,14191,14372,14552,14732,14912,15090,15269,15446,15623,15800,15976,16151,16325,16499,16673,16846,17018,17189,17360,17530,17700,17869,18037,18204,18371,18537,18703,18868,19032,19195,19357,19519,19680,19841,20001,20159,20318,20475,20631,20787,20942,21097,21250,21403,21554,21706,21856,22005,22154,22301,22448,22594,22740,22884,23027,23170,23312,23453,23593,23732,23870,24007,24143,24279,24414,24547,24680,24812,24943,25072,25201,25329,25457,25583,25708,25832,25955,26077,26199,26319,26438,26557,26674,26790,26905,27020,27133,27245,27356,27466,27576,27684,27791,27897,28002,28106,28208,28310,28411,28510,28609,28707,28803,28898,28993,29086,29178,29269,29359,29447,29535,29621,29707,29791,29874,29956,30037,30117,30196,30273,30350,30425,30499,30572,30644,30714,30784,30852,30919,30985,31050,31114,31176,31237,31298,31357,31414,31471,31526,31581,31634,31685,31736,31785,31834,31881,31927,31971,32015,32057,32098,32138,32176,32214,32250,32285,32319,32351,32383,32413,32442,32469,32496,32521,32545,32568,32589,32610,32629,32647,32663,32679,32693,32706,32718,32728,32737,32745,32752,32758,32762,32765,32767,32767,32767,32765,32762,32758,32752,32745,32737,32728,32718,32706,32693,32679,32663,32647,32629,32610,32589,32568,32545,32521,32496,32469,32442,32413,32383,32351,32319,32285,32250,32214,32177,32138,32098,32057,32015,31971,31927,31881,31834,31785,31736,31685,31634,31581,31526,31471,31414,31357,31298,31237,31176,31114,31050,30985,30919,30852,30784,30714,30644,30572,30499,30425,30350,30273,30196,30117,30037,29956,29874,29791,29707,29621,29535,29447,29359,29269,29178,29086,28993,28898,28803,28707,28609,28511,28411,28310,28208,28106,28002,27897,27791,27684,27576,27466,27356,27245,27133,27020,26905,26790,26674,26557,26438,26319,26199,26078,25955,25832,25708,25583,25457,25330,25202,25073,24943,24812,24680,24547,24414,24279,24144,24007,23870,23732,23593,23453,23312,23170,23027,22884,22740,22594,22448,22301,22154,22005,21856,21706,21555,21403,21250,21097,20942,20787,20632,20475,20318,20159,20001,19841,19681,19519,19358,19195,19032,18868,18703,18537,18371,18204,18037,17869,17700,17530,17360,17189,17018,16846,16673,16500,16325,16151,15976,15800,15623,15446,15269,15090,14912,14732,14553,14372,14191,14010,13828,13645,13462,13279,13094,12910,12725,12539,12353,12167,11980,11793,11605,11417,11228,11039,10849,10659,10469,10278,10087,9896,9704,9512,9319,9126,8933,8739,8545,8351,8156,7962,7766,7571,7375,7179,6983,6786,6589,6392,6195,5997,5800,5602,5403,5205,5006,4808,4609,4410,4210,4011,3811,3611,3411,3211,3011,2811,2611,2410,2210,2009,1808,1607,1407,1206,1005,804,603,402,201,0,-200,-402,-603,-804,-1005,-1206,-1406,-1607,-1808,-2009,-2209,-2410,-2610,-2811,-3011,-3211,-3411,-3611,-3811,-4011,-4210,-4409,-4608,-4807,-5006,-5205,-5403,-5601,-5799,-5997,-6195,-6392,-6589,-6786,-6983,-7179,-7375,-7571,-7766,-7961,-8156,-8351,-8545,-8739,-8933,-9126,-9319,-9511,-9704,-9896,-10087,-10278,-10469,-10659,-10849,-11039,-11228,-11416,-11605,-11792,-11980,-12167,-12353,-12539,-12725,-12910,-13094,-13278,-13462,-13645,-13828,-14010,-14191,-14372,-14552,-14732,-14912,-15090,-15269,-15446,-15623,-15800,-15975,-16151,-16325,-16499,-16673,-16846,-17018,-17189,-17360,-17530,-17700,-17869,-18037,-18204,-18371,-18537,-18703,-18867,-19032,-19195,-19357,-19519,-19680,-19841,-20000,-20159,-20317,-20475,-20631,-20787,-20942,-21096,-21250,-21403,-21554,-21705,-21856,-22005,-22154,-22301,-22448,-22594,-22739,-22884,-23027,-23170,-23312,-23452,-23592,-23732,-23870,-24007,-24143,-24279,-24413,-24547,-24680,-24812,-24943,-25072,-25201,-25329,-25457,-25583,-25708,-25832,-25955,-26077,-26199,-26319,-26438,-26556,-26674,-26790,-26905,-27020,-27133,-27245,-27356,-27466,-27576,-27684,-27791,-27897,-28002,-28105,-28208,-28310,-28411,-28510,-28609,-28707,-28803,-28898,-28992,-29086,-29178,-29269,-29358,-29447,-29535,-29621,-29707,-29791,-29874,-29956,-30037,-30117,-30196,-30273,-30350,-30425,-30499,-30572,-30644,-30714,-30784,-30852,-30919,-30985,-31050,-31114,-31176,-31237,-31298,-31356,-31414,-31471,-31526,-31580,-31634,-31685,-31736,-31785,-31834,-31881,-31927,-31971,-32015,-32057,-32098,-32138,-32176,-32214,-32250,-32285,-32319,-32351,-32383,-32413,-32442,-32469,-32496,-32521,-32545,-32568,-32589,-32610,-32629,-32647,-32663,-32679,-32693,-32706,-32718,-32728,-32737,-32745,-32752,-32758,-32762,-32765,-32767
#endif
	};
	const int16_t *cv, *sv;
	int16comp_t *p1, *p2;
	int32_t a, b, c, d;
	unsigned int s, ss, w, ww;


	w = 1; s = N_FFT / 2;
	do {
		p1 = fftbuf; p2 = fftbuf + s;
		ww = w;
		do {
			cv = &sintbl[N_FFT / 4]; sv = &sintbl[0];
			ss = s;
			do {
				c = p1->r >> 1; d = p2->r >> 1; a = c - d; p1->r = c + d;
				c = p1->i >> 1; d = p2->i >> 1; b = c - d; p1->i = c + d;
				p1++;
				p2->r = (a * *cv + b * *sv) >> 15;
				p2->i = (b * *cv - a * *sv) >> 15;
				p2++;
				cv += w; sv += w;
			} while (--ss);
			p1 += s; p2 += s;
		} while (--ww);
		w *= 2; s /= 2;
	} while (s);
}

void int16fft_output_scalar (
	int16comp_t* fftbuf,	/* Pointer to the FFT working buffer (processed data) */
	uint16_t* outbuf		/* Pointer to the scalar data output buffer */
)
{
	uint32_t i, s;
	int32_t a, b;


	s = 0;
	do {
		i = 0;
		do {
			a = fftbuf[Tbl_brev[i] + s].r;
			b = fftbuf[Tbl_brev[i] + s].i;
			*outbuf++ = isqrt32((uint32_t)(a * a) + (uint32_t)(b * b));
		} while (++i < N_FFT / 2);
	} while (s--);
}

